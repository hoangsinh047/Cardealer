<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap"
          rel="stylesheet">

    <title>CAR DEALER WEBSITE</title>

    <link rel="stylesheet" type="text/css" th:href="@{assets/css/bootstrap.min.css}">

    <link rel="stylesheet" type="text/css" th:href="@{assets/css/font-awesome.css}">

    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/chat.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .image-thumb {
            width: 100%;
            height: 200px; /* hoặc giá trị phù hợp với thiết kế của bạn */
            overflow: hidden;
        }

        .image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    </style>
</head>

<body>

<!-- ***** Preloader Start ***** -->
<div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
        <span class="dot"></span>
        <div class="dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>
<!-- ***** Preloader End ***** -->


<!-- ***** Header Area Start ***** -->
<div th:replace="~{client/include/header :: header}"></div>
<!-- ***** Header Area End ***** -->
<!-- ***** Chat Area Start ***** -->
<div th:replace="~{client/include/chat :: chat}"></div>

<!-- Nút mở chat -->
<div class="chat-toggle">
    <i class="fa fa-comments" style="font-size: 24px; color: white;"></i>
</div>

<!-- ***** Chat Area End ***** -->

<!-- ***** Call to Action Start ***** -->
<section class="section section-bg" id="call-to-action"
         th:style="|background-image: url('@{/assets/images/banner-image-1-1920x500.jpg}')|">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="cta-content">
                    <br>
                    <br>
                    <h2 style="font-family: 'Roboto', sans-serif; font-weight: bold">Sản phẩm <em>của chúng tôi!</em>
                    </h2>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ***** Call to Action End ***** -->

<!-- ***** Fleet Starts ***** -->
<section class="section" id="trainers">
    <div class="container">
        <br>
        <br>
        <div class="contact-form" style="font-family: 'Roboto', sans-serif">
            <form action="#" id="contact">
                <div class="row">
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Từ khóa:</label>
                            <input type="text" id="keyword" class="form-control" placeholder="Nhập từ khóa">
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Used/New:</label>
                            <select id="status">
                                <option value="">--All --</option>
                                <option value="Xe mới">Xe mới</option>
                                <option value="Xe cũ">Xe cũ</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Kiểu xe:</label>

                            <select id="type">
                                <option value="">--All --</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Suv">Suv</option>
                                <option value="Cuv">Cuv</option>
                                <option value="Hatchback">Hatchback</option>
                                <option value="Bán tải">Bán tải</option>
                                <option value="Sport">Sport</option>
                                <option value="Mpv">Mpv</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Hãng xe:</label>

                            <select id="brand">
                                <option value="">-- All --</option>
                                <option th:each="manufacturer : ${manufacturer}"
                                        th:value="${manufacturer.id}"
                                        th:text="${manufacturer.name}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Khoảng giá:</label>

                            <select id="price">
                                <option value="">--Tất cả--</option>
                                <option value="1">Dưới 500 triệu</option>
                                <option value="2">500 triệu - 1 tỷ</option>
                                <option value="3">Trên 1 tỷ</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Odo:</label>
                            <select id="odo">
                                <option value="">--Tất cả--</option>
                                <option value="1">Dưới 50,000 km</option>
                                <option value="2">50,000 - 100,000 km</option>
                                <option value="3">Trên 100,000 km</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Nhiên liệu:</label>
                            <select id="fuel">
                                <option value="">-- All --</option>
                                <option value="Xăng">Xăng</option>
                                <option value="Dầu">Dầu</option>
                                <option value="Động cơ Hybrid">Hybrid</option>
                                <option value="Điện">Điện</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="form-group">
                            <label>Hộp số:</label>
                            <select id="gearbox">
                                <option value="">-- All --</option>
                                <option value="Số sàn">Số sàn</option>
                                <option value="Số tự động">Số tự động</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-sm-4 offset-sm-4">
                    <div class="main-button text-center">
                        <button type="button" onclick="searchCars()">Tìm kiếm</button>
                    </div>
                </div>
                <br>
                <br>
            </form>
        </div>

        <div class="row" id="car-results">
            <div class="col-lg-4" th:each="product : ${products}">
                <div class="trainer-item">
                    <div class="image-thumb">
                        <img th:src="@{${#strings.arraySplit(product.imageUrl, ',')[0]}}" alt="Car Image">
                    </div>
                    <div class="down-content">
                <span>
                    <sup>Giá từ: </sup><span
                        th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')} +' đ '"></span>
                </span>

                        <h4 th:text="${product.name}"></h4>

                        <p>
                            <i class="fa fa-dashboard"></i> <span th:text="${product.odo}"></span> km &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-cog"></i> <span th:text="${product.gearbox}"></span> &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-tag"></i> <span th:text="${product.manufacturerName}"></span>
                        </p>

                        <ul class="social-icons">
                            <li><a th:href="@{/cars/{id}(id=${product.id})}" style="font-family: 'Roboto', sans-serif; font-weight: bold">+ Chi tiết</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <br>

        <nav>
            <ul class="pagination pagination-lg justify-content-center" id="pagination"></ul>
        </nav>

    </div>
</section>
<!-- ***** Fleet Ends ***** -->


<!-- ***** Footer Start ***** -->
<div th:replace="~{client/include/footer:: footer}"></div>


<!-- jQuery -->
<script th:src="@{assets/js/jquery-2.1.0.min.js}"></script>

<!-- Bootstrap -->
<script th:src="@{assets/js/popper.js}"></script>
<script th:src="@{assets/js/bootstrap.min.js}"></script>

<!-- Plugins -->
<script th:src="@{assets/js/scrollreveal.min.js}"></script>
<script th:src="@{assets/js/waypoints.min.js}"></script>
<script th:src="@{assets/js/jquery.counterup.min.js}"></script>
<script th:src="@{assets/js/imgfix.min.js}"></script>
<script th:src="@{assets/js/mixitup.js}"></script>
<script th:src="@{assets/js/accordions.js}"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script th:src="@{/assets/js/chat.js}"></script>

<!-- Global Init -->
<script th:src="@{assets/js/custom.js}"></script>
<script>
    // Mobile menu toggle
    $('.menu-trigger').click(function () {
        $('.nav').toggleClass('active2');
    });
</script>
<script>
    let start = 0;
    const total = 6; // Số sản phẩm mỗi trang
    document.addEventListener("DOMContentLoaded", function () {
        searchCars(); // Gọi hàm ngay khi trang load
    });

    // Hàm format số tiền sang định dạng Việt Nam
    function formatCurrency(amount) {
        return amount.toLocaleString('vi-VN') + ' đ';
    }

    // Hàm hiển thị kết quả tìm kiếm
    function displayResults(results) {
        const container = document.getElementById("car-results");
        container.innerHTML = ''; // Xóa kết quả cũ

        if (results.length === 0) {
            container.innerHTML = '<div class="col-12 text-center"><p>Không tìm thấy xe phù hợp.</p></div>';
            return;
        }

        results.forEach(product => {
            const image = product.imageUrl ? product.imageUrl.split(',')[0] : 'assets/images/no-image.jpg';
            const price = formatCurrency(product.price);
            const html = `
                <div class="col-lg-4">
                    <div class="trainer-item">
                        <div class="image-thumb">
                            <img src="${image}" alt="Car Image">
                        </div>
                        <div class="down-content">
                            <span><sup>Giá từ: </sup><span>${price}</span></span>
                            <h4>${product.name}</h4>
                            <p>
                                <i class="fa fa-dashboard"></i> ${product.odo} km &nbsp;&nbsp;&nbsp;
                                <i class="fa fa-cog"></i> ${product.gearbox} &nbsp;&nbsp;&nbsp;
                                <i class="fa fa-tag"></i> ${product.manufacturerName || ''}
                            </p>
                            <ul class="social-icons">
                                <li><a href="/cars/${product.id}">+ Chi tiết</a></li>
                            </ul>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }

    // Hàm hiển thị phân trang
    function setupPagination(totalItems, currentStart) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const pageSize = 6;
        const totalPages = Math.ceil(totalItems / pageSize);
        const currentPage = Math.floor(currentStart / pageSize);

        // Nút Previous
        if (currentPage > 0) {
            pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous" onclick="searchCars(${currentStart - pageSize})">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>`;
        }

        // Số trang
        for (let i = 0; i < totalPages; i++) {
            const pageStart = i * pageSize;
            pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="searchCars(${pageStart})">${i + 1}</a>
            </li>`;
        }

        // Nút Next
        if (currentPage < totalPages - 1) {
            pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Next" onclick="searchCars(${currentStart + pageSize})">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>`;
        }
    }

    // Hàm tìm kiếm xe với phân trang dựa trên start và total
    async function searchCars(newStart = 0) {
        start = newStart;

        const keyword = document.getElementById('keyword').value.trim();
        const status = document.getElementById('status').value;
        const type = document.getElementById('type').value;
        const brand = document.getElementById('brand').value;
        const price = document.getElementById('price').value;
        const odo = document.getElementById('odo').value;
        const fuel = document.getElementById('fuel').value;
        const gearbox = document.getElementById('gearbox').value;

        // Xử lý giá cho khoảng giá
        let minPrice = null, maxPrice = null;
        if (price === "1") {
            minPrice = 0;
            maxPrice = 500000000;
        } else if (price === "2") {
            minPrice = 500000000;
            maxPrice = 1000000000;
        } else if (price === "3") {
            minPrice = 1000000000;
        }

        // Xử lý Odometer
        let minOdo = null, maxOdo = null;
        if (odo === "1") {
            minOdo = 0;
            maxOdo = 50000;
        } else if (odo === "2") {
            minOdo = 50000;
            maxOdo = 100000;
        } else if (odo === "3") {
            minOdo = 100000;
        }

        // Gọi API
        let url = '/api/product/getAllProduct?search=' + encodeURIComponent(keyword) +
            '&status=' + encodeURIComponent(status) +
            '&type=' + encodeURIComponent(type) +
            '&manufacturer=' + encodeURIComponent(brand) +
            '&fuel=' + encodeURIComponent(fuel) +
            '&gearbox=' + encodeURIComponent(gearbox) +
            '&start=' + start +
            '&total=' + total;

        if (minPrice !== null) url += '&minPrice=' + encodeURIComponent(minPrice);
        if (maxPrice !== null) url += '&maxPrice=' + encodeURIComponent(maxPrice);
        if (minOdo !== null) url += '&minOdo=' + encodeURIComponent(minOdo);
        if (maxOdo !== null) url += '&maxOdo=' + encodeURIComponent(maxOdo);

        try {
            const response = await fetch(url);
            const data = await response.json();

            console.log(data); // 👈 thêm dòng này để xem toàn bộ dữ liệu trả về


            displayResults(data.data);
            const pagination = document.getElementById("pagination");
            if (data.count <= total) {
                pagination.classList.add("d-none");
                pagination.innerHTML = ''; // 👈 xoá nút nếu có từ lần trước
            } else {
                pagination.classList.remove("d-none"); // 👈 hiển thị lại nếu đủ trang
                setupPagination(data.count, start);
            }

        } catch (error) {
            console.error('Lỗi khi tìm kiếm:', error);
        }
    }
</script>

</body>
</html>